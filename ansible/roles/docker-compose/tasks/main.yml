# ansible/roles/docker-compose/tasks/main.yml
---
- name: Ensure apt cache is up to date
  apt:
    update_cache: yes

- name: Install Docker Compose plugin via apt
  apt:
    name: docker-compose-plugin
    state: present
  register: dc_apt
  failed_when: false

- name: Ensure python3-pip is installed (for pip fallback & venv support)
  apt:
    name: python3-pip
    state: present

- name: Install distro Docker SDK & requests packages
  apt:
    name:
      - python3-docker
      - python3-requests
    state: present

- name: Install legacy docker-compose via pip3 if plugin not available
  pip:
    name: docker-compose
    executable: pip3
  when: dc_apt.failed

- name: Build list of compose files
  set_fact:
    compose_files: >-
      {{
        [ 'docker-compose.yml' ]
        + ( override_file.stat.exists | bool
            and [ 'docker-compose.override.yml' ] or [] )
      }}

- name: Tear down any existing homelab stack
  community.docker.docker_compose_v2:
    project_src: "{{ homelab_dest }}"
    files: "{{ compose_files }}"
    state: absent
    remove_orphans: true
    remove_volumes: true

- name: Ensure AdGuard data directory has strict permissions
  ansible.builtin.file:
    path: /var/lib/docker/volumes/homelab-docker_adguard_data/_data
    state: directory
    mode: '0700'

- name: Ensure AdGuard config directory has strict permissions
  ansible.builtin.file:
    path: /var/lib/docker/volumes/homelab-docker_adguard_config/_data
    state: directory
    mode: '0700'

- name: Bring up the full homelab stack
  community.docker.docker_compose_v2:
    project_src: "{{ homelab_dest }}"
    files: "{{ compose_files }}"
    state: present
    pull: always
    recreate: auto

# Post-deploy: fix in-container permissions so AdGuard will serve its UI
- name: Fix AdGuard “work” directory permissions in-container
  ansible.builtin.command: >
    docker exec adguardhome chmod 0700 /opt/adguardhome/work
  become: true
  when: inventory_hostname == 'homelab-server'

- name: Fix AdGuard “conf” directory permissions in-container
  ansible.builtin.command: >
    docker exec adguardhome chmod 0700 /opt/adguardhome/conf
  become: true
  when: inventory_hostname == 'homelab-server'